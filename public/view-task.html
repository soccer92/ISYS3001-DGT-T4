<!DOCTYPE html>
<html lang="en-AU">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Tasks &#8212; Task Flow</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Nav -->
    <nav>
        <!-- Hamburger Functionality -->
        <div class="hamburger">
            <a href="create-task.html">Create a Task</a>
            <a href="" class="active">View Tasks</a>
            <a href="#" id="exportCSV">Export Tasks as CSV</a>
            <a href="#" id="exportPDF">Export Tasks as PDF</a>
            <a href="#" id="logoutLink">Log out</a>
        </div>
        <a href="javascript:void(0);" onclick="hamburgerNavToggle()">
            <img src="images/Hamburger.svg" alt="Hamburger Menu Icon">
        </a>
        <a href="index.html" class="application-title">Task Flow</a>
        <img src="images/Task-Flow-Logo.png" alt="Task Flow Logo" class="logo">
    </nav>
    <h1 style="text-align: center;">View Tasks</h1>
    <!-- Main Content -->
    <main>
        <button id="email-summary-btn" type="button">Email me Task Summary</button>
        <!-- View Tabs -->
        <div class="view-tabs">
            <button class="tab-button active" onclick="openView(event, 'list')">List View</button>
            <button class="tab-button" onclick="openView(event, 'kanban')">Kanban View</button>
        </div>

        <!-- Display Task List -->
        <section id="list" class="content-view">
            <ul id="task-list"></ul>
        </section>

        <!-- Display Kanban View -->
        <section id="kanban" class="content-view" style="display:none;">
            <div class="kanban-board">
                <div class="kanban-column" data-status="todo">
                    <h2>To Do</h2>
                    <div class="kanban-tasks"></div>
                </div>
                <div class="kanban-column" data-status="in_progress">
                    <h2>In Progress</h2>
                    <div class="kanban-tasks"></div>
                </div>
                <div class="kanban-column" data-status="done">
                    <h2>Completed</h2>
                    <div class="kanban-tasks"></div>
                </div>
            </div>
        </section>

        <!-- Edit Tasks -->
        <section>
            <form id="edit-form" style="display: none;">
                <h2>Edit Task</h2>
                <input type="hidden" id="edit-task-id">

                <!-- Task Title -->
                <div class="input-wrapper">
                    <label for="edit-task-title">Task Title:</label>
                    <input type="text" id="edit-task-title" required>
                </div>

                <!-- Task Description -->
                <div class="input-wrapper">
                    <label for="edit-task-desc">Task Description:</label>
                    <textarea id="edit-task-desc" name="edit-task-desc"></textarea>
                </div>

                <!-- Task Priority -->
                <div class="input-wrapper">
                    <label for="edit-task-priority">Priority:</label>
                    <select id="edit-task-priority" required>
                        <option value="high">High Priority</option>
                        <option value="medium">Medium Priority</option>
                        <option value="low">Low Priority</option>
                    </select>
                </div>

                <!-- Due Date -->
                <div class="input-wrapper">
                    <label for="edit-date">Due Date:</label>
                    <input type="date" id="edit-date" name="edit-date">
                </div>

                <!-- Task Recurrence -->
                <div class="input-wrapper">
                    <label for="edit-task-recurr">Recurrence:</label>
                    <select id="edit-task-recurr">
                        <option value="none">None</option>
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                </div>

                <div class="input-wrapper">
                    <label for="edit-task-recurr-until">Repeat until:</label>
                    <input type="date" id="edit-task-recurr-until" name="edit-task-recurr-until">
                </div>

                <!-- Task Completion Status -->
                <div class="input-wrapper">
                    <label for="edit-task-status">Status:</label>
                    <select id="edit-task-status" required>
                        <option value="todo">To Do</option>
                        <option value="in_progress">In Progress</option>
                        <option value="done">Completed</option>
                    </select>
                </div>

                <!-- Submit Form -->
                <button type="submit">Save Changes</button>
                <button type="button" id="cancel-edit">Cancel</button>
                <button type="button" onclick="deleteTask(document.getElementById('edit-task-id').value)">Delete</button>
            </form>
        </section>
    </main>

    <!-- Footer -->
    <footer>
        <p><b>Completion Status: </b><span id="completion-status">Loading...</span></p>
        <div class="progress-wheel"></div>
        <p>Keep up the Good Work!</p>
    </footer>

    <script>
        function hamburgerNavToggle() {
            var hamburgerLinks = document.getElementsByClassName("hamburger")[0];
            hamburgerLinks.style.display = hamburgerLinks.style.display === "block" ? "none" : "block";
        }
    </script>
    <script>
        function render(tasks) {
            const ul = document.getElementById('task-list');
            if (!ul) return;

            const priorityLabels = { high: "High Priority", medium: "Medium Priority", low: "Low Priority" };
            const statusLabels = { todo: "To Do", in_progress: "In Progress", done: "Completed" };

            ul.innerHTML = (tasks || []).map(t => {
                const pr = priorityLabels[t.priority] || t.priority;
                const st = statusLabels[t.status] || t.status;
                const dd = t.due_at ? new Date(t.due_at).toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric' }) : '';
                return `
                    <li data-id="${t.id}" data-priority="${t.priority}">
                        <strong>${escapeHtml(t.title)}</strong>
                        <em>${escapeHtml(st)}</em>
                        ${t.due_at ? `<p><b>Due:</b> ${dd}</p>` : ''}
                        ${t.recur ? `<p class="recur-info">Repeats ${t.recur} until ${t.recur_until ? new Date(t.recur_until).toLocaleDateString('en-AU') : '—'}</p>` : ''}
                        <div class="task-actions">
                            <button type="button" class="edit">Edit</button>
                        </div>
                    </li>`;
            }).join('');
        }

        async function refreshEdit() {
            const tasks = await fetchTasks();
            render(tasks);
            updateCompletionStatus();
        }

        document.addEventListener('DOMContentLoaded', () => {
            const editForm = document.getElementById('edit-form');
            const editTaskId = document.getElementById('edit-task-id');
            const editTaskTitle = document.getElementById('edit-task-title');
            const editTaskDesc = document.getElementById('edit-task-desc');
            const editTaskPriority = document.getElementById('edit-task-priority');
            const editDate = document.getElementById('edit-date');
            const editTaskRecurr = document.getElementById('edit-task-recurr');
            const editTaskRecurrUntil = document.getElementById('edit-task-recurr-until');
            const editTaskStatus = document.getElementById('edit-task-status');
            const cancelEdit = document.getElementById('cancel-edit');

            refreshEdit();

            editForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const dueValue = editDate.value ? new Date(editDate.value).toISOString() : undefined;
                const recurValue = editTaskRecurr.value !== 'none' ? editTaskRecurr.value : undefined;

                if (recurValue && !dueValue) {
                    alert('Please set a due date when you enable recurrence.');
                    return;
                }

                const patchData = {
                    title: editTaskTitle.value,
                    description: editTaskDesc.value,
                    priority: editTaskPriority.value,
                    status: editTaskStatus.value
                };
                if (dueValue) patchData.due_at = dueValue;
                if (recurValue) patchData.recur = recurValue;
                if (editTaskRecurrUntil.value) patchData.recur_until = new Date(editTaskRecurrUntil.value).toISOString();

                try {
                    const res = await fetch(`/api/tasks/${editTaskId.value}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(patchData)
                    });

                    if (!res.ok) {
                        const err = await res.json().catch(() => ({}));
                        alert('Failed to update task: ' + (err.message || res.status));
                        return;
                    }

                    alert('Task updated successfully');
                    editForm.style.display = 'none';
                    refreshEdit();
                } catch (err) {
                    alert('Failed to update task: ' + err.message);
                }
            });

            cancelEdit.addEventListener('click', () => {
                editForm.style.display = 'none';
            });

            const emailBtn = document.getElementById('email-summary-btn');
            if (emailBtn) {
                emailBtn.addEventListener('click', async () => {
                    emailBtn.disabled = true;
                    emailBtn.textContent = 'Sending...';
                    try {
                        const res = await fetch('/api/tasks/email-summary', {
                            method: 'POST',
                            credentials: 'include'
                        });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data?.message || `HTTP ${res.status}`);
                        alert('Email sent! Check your inbox.');
                    } catch (err) {
                        console.error('Email summary failed:', err);
                        alert('Failed to send summary email.');
                    } finally {
                        emailBtn.disabled = false;
                        emailBtn.textContent = 'Email me my task summary';
                    }
                });
            }
        });
    </script>
    <script>
        function openView(evt, viewName) {
            document.querySelectorAll('.content-view').forEach(view => view.style.display = 'none');
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));

            document.getElementById(viewName).style.display = 'block';
            evt.currentTarget.classList.add('active');

            if (viewName === 'list') refreshEdit();
            if (viewName === 'kanban') renderKanban();
            if (viewName !== 'list') document.getElementById('edit-form').style.display = 'none';
        }

        async function renderKanban() {
            const tasks = await fetchTasks(); // Refers to app.js.
            document.querySelectorAll('.kanban-column').forEach(col => {
            const status = col.dataset.status;
            const card = col.querySelector('.kanban-tasks');
            card.innerHTML = tasks
            .filter(t => t.status === status)
            .map(t => `
                <div class="kanban-task">
                    <b>${t.title}</b>
                    ${t.description ? `<p>${t.description}</p>` : ''}
                    ${t.due_at ? `<p>Due: ${new Date(t.due_at).toLocaleDateString('en-AU')}</p>` : ''}
                    ${t.recur ? `<p>Repeats ${t.recur} until ${t.recur_until ? new Date(t.recur_until).toLocaleDateString('en-AU') : '—'}</p>` : ''}
                </div>
            `)
            .join('');
            });
        }
    </script>
    <script src="app.js"></script>
</body>
</html>